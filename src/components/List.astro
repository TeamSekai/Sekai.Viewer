---
---

<div class="grid-container">
</div>

<div id="load-more" class="flex justify-center flex-row items-center">
	<div class="animate-spin h-10 w-10 border-4 border-blue-500 rounded-full border-t-transparent"></div>
	<h1 class="m-4 text-2xl">Loading...</h1>
</div>

<style>
	.grid-container {
		display: grid;
		grid-auto-flow: column;
		max-width: 100vw;
		width: 100%;
		margin-inline: auto;
		gap: 10px;
		grid-auto-flow: dense;
		grid-template-columns: repeat(2, 1fr);
	}

	@media screen and (max-width: 768px) {
		.grid-container {
			grid-template-columns: repeat(1, 1fr);
		}
	}

	@media screen and (max-width: 480px) {
		.grid-container {
			grid-template-columns: repeat(1, 1fr);
		}
	}
</style>

<style is:global>
	.misc-container {
		margin: 20px;
	}
	.grid-child {
		margin: 0;
	}
	.grid-child img {
		display: block;
		width: 100%;
		height: auto;
		object-fit: cover;
	}
	.grid-child video {
		display: block;
		width: 100%;
		height: auto;
		object-fit: cover;
	}
	.misc-container {
		text-align: center;
		margin: 0;
		border: 2px solid #333;
	}
	.grid-child {
		margin: 0;
	}
	.grid-child img {
		display: block;
		width: 100%;
		height: auto;
		object-fit: cover;
	}
	.grid-child video {
		display: block;
		width: 100%;
		height: auto;
		object-fit: cover;
	}
	.hidden {
		opacity: 0;
	}
</style>

<script>
	console.log('Hello Sekai!')
	let offset = 0;
	let loading = false;
	async function cdnfetch() {
		console.log('Fetching')
		loading = true;
		document.getElementById('load-more').classList.remove('hidden');
		try {
			const path = location.pathname
			const repl = path.replace(/\/$/, "")
			const apiurl = `https://cdn.ringoxd.dev/api/files${repl}/`
			const clienturl = `https://cdn.ringoxd.dev/${repl}`
			const res = await fetch(`${apiurl}?offset=${offset}`, {
				mode: 'cors'
			});
			const newItems = await res.json();
			const gridContainer = document.querySelector('.grid-container');
			
			const miscItems = [];
			const imageItems = [];
			const videoItems = [];

			newItems.forEach(file => {
				const ext = file.name.split('.').pop().toLowerCase();
				const newItem = document.createElement('div');
				newItem.classList.add('grid-child');
 
				if (!['png', 'jpg', 'jpeg', 'gif', 'bmp', 'svg'].includes(ext) && !['mp4', 'webm', 'ogg'].includes(ext)) {
					newItem.innerHTML = `<div class="misc-container"><a href="${file.name}"><p>${file.name}(ディレクトリ)</p></a></div>`;
					miscItems.push(newItem);
				} else if (['png', 'jpg', 'jpeg', 'gif', 'bmp', 'svg'].includes(ext)) {
					newItem.innerHTML = `<a href="${clienturl}${file.name}" class="link"><img src="${clienturl}${file.name}" alt="image" /></a>`;
					imageItems.push(newItem);
				} else if (['mp4', 'webm', 'ogg'].includes(ext)) {
					newItem.innerHTML = `<a href="${clienturl}${file.name}" class="link"><video src="${clienturl}${file.name}" controls preload="metadata"></video></a>`;
					videoItems.push(newItem);
				}
			});

			// 画像でも動画でもないファイルを最初に追加
			miscItems.forEach(item => gridContainer.appendChild(item));
			imageItems.forEach(item => gridContainer.appendChild(item));
			videoItems.forEach(item => gridContainer.appendChild(item));

			offset += 10;
		} catch (e) {
			console.error(e);
		} finally {
			loading = false;
			document.getElementById('load-more').classList.add('hidden');
		}
	}
	async function main() {
		console.log('Called')
		cdnfetch()
		const loadMoreDiv = document.getElementById('load-more');
		const observer = new IntersectionObserver(async (entries) => {
			if (entries[0].isIntersecting && !loading) {
				await cdnfetch()
			}
		}, {
			rootMargin: '100px',
		});

		observer.observe(loadMoreDiv);
		}
	
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', () => {
			main()
		});
	} else {
		main()
	}
</script>